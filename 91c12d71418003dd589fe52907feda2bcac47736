  - name: Cache Gradle
    uses: actions/cache@v4
    with:
      path: |
        ~/.gradle/caches
        ~/.gradle/wrapper
      key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
      restore-keys: |
        ${{ runner.os }}-gradle-

  - name: Set up JDK 17
    uses: actions/setup-java@v4
    with:
      distribution: temurin
      java-version: 17

  - name: Set up Android emulator & SDK (prepare only)
    uses: reactivecircus/android-emulator-runner@v2
    with:
      api-level: 31
      target: google_apis
      arch: x86_64
      emulator-options: -no-window -no-audio -no-boot-anim
      script: false

  - name: Build Android (Gradle)
    run: |
      chmod +x ./gradlew
      ./gradlew assembleDebug --no-daemon
    shell: bash

  - name: Run unit tests (JVM)
    run: |
      ./gradlew test --no-daemon
    shell: bash

  - name: Run instrumentation tests on emulator
    uses: reactivecircus/android-emulator-runner@v2
    with:
      api-level: 31
      target: google_apis
      arch: x86_64
      emulator-options: -no-window -no-audio -no-boot-anim
      script: ./gradlew connectedAndroidTest --no-daemon
